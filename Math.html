<html>
  <head>
    <style type="text/css">
      .selected {
        border-bottom: 1px solid red;
        border-right: 1px solid red;
      }
      .pass { color: green; display: none; }
      .fail { color: red; }
    </style>
    <script type="text/javascript" src="tests.js"></script>
    <script type="text/javascript;version=1.8">
      var output;
      function start() {
        jsMath.init();
        output = document.getElementById("output");
        runTests(document.getElementById("testResults"));
      }
      var MMLNS = "http://www.w3.org/1998/Math/MathML";
      var Operators = [43, // +
                       45, // -
                       42, // *
                       47, // /
                       61, // =
                       94, // ^
                       95];// _
      var jsMath = {
        init: function() {
          window.addEventListener("keypress", this, false);
        },
        current: null,
        handleEvent: function(aEvent) {
          if (aEvent.charCode > 96 && aEvent.charCode < 123) {
            this.handleLowerCaseLetter(aEvent);
          } else if (aEvent.charCode > 64 && aEvent.charCode < 91) {
            this.handleUpperCaseLetter(aEvent);
          } else if (Operators.indexOf(aEvent.charCode) > -1) {
            this.handleOperator(aEvent);
          } else if (aEvent.charCode > 47 && aEvent.charCode < 58) {
            this.handleNumber(aEvent);
          } else if (aEvent.charCode == 32) {
            this.selectParent(aEvent);
          } else {
            //console.log(aEvent.charCode);
          }
          aEvent.preventDefault();
        },
        selectParent: function(aEvent) {
          if (this.current.parent) {
            this.current = this.current.parent;
          }
          MathMLDisplayer.selectParent();
        },
        handleNumber: function(aEvent) {
          var char = String.fromCharCode(aEvent.charCode);
          this.addToNumber(char);
        },
        handleLowerCaseLetter: function(aEvent) {
          var char = String.fromCharCode(aEvent.charCode);
          this.addToVar(char);
        },
        handleUpperCaseLetter: function(aEvent) {
          var char = String.fromCharCode(aEvent.charCode);
          this.addToVar(char);
        },
        addToNumber: function(aChar) { this.addToCurrent("number", aChar); },
        addToVar: function(aChar) { this.addToCurrent("variable", aChar); },
        addToCurrent: function(aType, aChar) {
          if (this.current && this.current.type == aType) {
            this.current.name += aChar;
          } else {
            var node = null;
            if (aType == "variable") node = new Variable(aChar);
            if (aType == "number") node = new NumberNode(aChar);
            this.addToEquation(node);
          }
          //writeObject(this.equation);
          //console.log(this.getEquationAsJS());
        },
        handleOperator: function(aEvent) {
          if (!this.current)
            this.current = new Variable(" ");

          var char = String.fromCharCode(aEvent.charCode);
          var node = new Operator(char);
          this.addToEquation(node);
        },

        addToEquation: function(aNode) {
          if (aNode.type == "operator") {
            if (this.current.parent) {
              aNode.addSubject(this.current.parent);
            } else {
              aNode.addSubject(this.current);
            }
            this.current = aNode;
            this.equation = aNode;
          } else {
            if (this.current) {
              if (this.current.type == "operator") {
                this.current.addSubject(aNode);
              } else {
                this.current.parent.addSubject(aNode);
              }
            }
            this.current = aNode;
            if (!this.equation)
              this.equation = this.current;
          }
        },

        getEquationAsJS: function() {
          return getJSText(this.equation);
        },
        reset: function() {
          this.current = null;
          this.equation = null;
        }
      }

      function NumberNode(aName) {
        this._name = aName;
        this.type = "number";
        this.parent = null;
        this._id = MathMLDisplayer.addNumber(this._name);
      }
      NumberNode.prototype = {
        set name(aVal) {
          MathMLDisplayer.updateNumber(this._id, aVal);
          this._name = aVal;
        },
        get name() { return this._name; }
      }

      function Variable(aName) {
        this._name = aName;
        this.type = "variable";
        this._id = MathMLDisplayer.addVar(this._name);
        this.parent = null;
      }
      Variable.prototype = {
        set name(aVal) {
          MathMLDisplayer.updateVar(this._id, aVal);
          this._name = aVal;
        },
        get name() { return this._name; }
      }

      function Operator(aType) {
        this._name = aType;
        this.type = "operator";
        this._id = MathMLDisplayer.addOperator(this._name);
        this.parent = null;
        this.subjects = [];
      }
      Operator.prototype = {
        set name(aVal) {
          MathMLDisplayer.updateOperator(this._id, aVal);
          this._name = aVal;
        },
        get name() { return this._name; },
        addSubject: function(aNode) {
          this.subjects.push(aNode);
          aNode.parent = this;
        }
      }

      function writeObject(aObj) {
        window.myObj = aObj;
        output.innerHTML = getText(aObj);
      }

      function getText(aObj, aPrefix) {
        if (!aPrefix) aPrefix = "";
        txt = "<li>" + aPrefix + aObj.name;

        if (aObj.subjects) {
          txt += "<ul>"
          for (var j = 0; j < aObj.subjects.length; j++) {
            txt += getText(aObj.subjects[j], j + ": ");
          }
          txt += "</ul>"
        }

        txt += "</li>";
        return txt;
      }

      function getJSText(aObj, aPrefix) {
        var txt = "";
        if (aObj.subjects) {
          if (aObj.name == "/") txt += "(";
          for (var j = 0; j < aObj.subjects.length; j++) {
            txt += getJSText(aObj.subjects[j]);
            if (j != aObj.subjects.length-1)
              txt += " " + aObj.name + " ";
          }
          if (aObj.name == "/") txt += ")";
        } else {
          return aObj.name;
        }
        return txt;
      }

      var MathMLDisplayer = {
        _tag: null,
        reset: function() {
          this._tag = null;
        },
        parentNodeTypes: ["mfrac", "mrow"],
        get tag() {
          if (!this._tag) {
            this._tag = document.createElementNS(MMLNS, "math");
            document.body.appendChild(this._tag);
            this.createTag("mrow", true);
          }
          return this._tag;
        },
        set tag(aVal) {
          if (this._tag)
            this._tag.classList.remove("selected");

          this._tag = aVal;
          this._tag.classList.add("selected");
          //console.log(this.tag.nodeName);
        },
        createTag: function(aName, aAppend) {
          var tag = document.createElementNS(MMLNS, aName);
          if (aAppend) {
            this.tag.appendChild(tag);
          } else if (this.parentNodeTypes.indexOf(aName) > -1) {
            // if this node is a parent, add our current node inside it
            this.tag.parentNode.appendChild(tag);
            tag.appendChild(this.tag);
          } else if (this.parentNodeTypes.indexOf(this.tag.nodeName) > -1) {
            // if our current node is an parent, add this inside it
            this.tag.appendChild(tag);
          } else {
            this.tag.parentNode.appendChild(tag);
          }
          this.tag = tag;
          return this.tag;
        },

        addVar: function(aChar) {
          var tag = this.createTag("mi");
          return this.updateVar(tag, aChar);
        },
        updateVar: function(aNode, aChars) {
          aNode.textContent = aChars;
          return aNode;
        },

        addOperator: function(aOperator) {
          var tag = null;
          if (aOperator == "/") {
            this.createTag("mfrac");
            tag = this.createTag("mrow", true);
          } else if (aOperator == "^") {
            this.createTag("msup");
            tag = this.createTag("mrow", true);
          } else if (aOperator == "_") {
            this.createTag("msub");
            tag = this.createTag("mrow", true);
          } else {
            tag = this.createTag("mo");
            this.updateOperator(tag, aOperator);
          }
          return tag;
        },
        updateOperator: function(aNode, aVal) {
          aNode.textContent = aVal;
          return aNode;
        },

        addNumber: function(aNumber, aUpdate) {
          var tag = this.createTag("mn");
          return this.updateNumber(tag, aNumber);
        },
        updateNumber: function(aNode, aVal) {
          aNode.textContent = aVal;
          return aNode;
        },
        selectParent: function() {
          if (this.tag.parentNode)
            this.tag = this.tag.parentNode;
          // if this node is the only child of its parent, we need to go up two levels
          //if (this.tag.childNodes.length == 1)
          //  this.selectParent();
          if (this.tag.nodeName == "mfrac") {
            //console.log("add row wrapping frac");
            this.createTag("mrow");
          } else if (this.tag.nodeName == "math") {
            this.tag = this.origin;
            //console.log("dont add row");
          }
        },
      }
    </script>
  </head>
  <body contentEditable="true" onload="start();">
    <div>Math!</div>
    <ul id="output"></ul>
    <ul id="testResults"></ul>
  </body>
</html>